<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>听写助手</title>
  <style>
    :root{
      --bg:#0b1220;
      --muted:rgba(255,255,255,.72);
      --text:rgba(255,255,255,.92);
      --line:rgba(255,255,255,.10);
      --btn:#ffffff;
      --btnText:#0b1220;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:16px;
      --yellow:#ffd84d;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 700px at 20% 10%, #1a2b55 0%, var(--bg) 45%) fixed;
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:720px; margin:0 auto;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:16px;
    }
    h1{
      font-size:22px;
      margin:0 0 10px;
      text-align:center;
      color:var(--yellow);
      letter-spacing:.5px;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      margin-bottom:12px;
      text-align:center;
    }
    textarea{
      width:100%;
      height:220px;
      resize:vertical;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:16px;
      line-height:1.45;
    }
    textarea::placeholder{color:rgba(255,255,255,.45);}
    .row{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:14px;
    }
    select{
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size:14px;
      appearance:none;
      padding-right:18px;
      cursor:pointer;
    }
    .chip .arrow{
      width:0; height:0;
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-top:6px solid rgba(255,255,255,.6);
      margin-left:-6px;
    }
    .badge{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
      height:fit-content;
      max-width:48vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    button{
      width:100%;
      border:none;
      border-radius:14px;
      padding:18px 18px;
      font-size:22px;
      font-weight:800;
      cursor:pointer;
      background: var(--btn);
      color: var(--btnText);
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      transition: transform .05s ease;
      margin-top:14px;
    }
    button:active{transform: translateY(1px);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>听写助手</h1>
      <div class="sub">一行一条。每条自动读 2 遍，再停指定秒数。只有一个按钮：开始 / 暂停 / 继续。</div>

      <textarea id="input" placeholder="粘贴作业内容（每行一条）
例如：
严肃
默默
清晰"></textarea>

      <div class="row">
        <div class="chip">
          <span>每条停</span>
          <select id="gap">
            <option value="3" selected>3 秒</option>
            <option value="5">5 秒</option>
            <option value="8">8 秒</option>
            <option value="10">10 秒</option>
          </select>
          <span class="arrow"></span>
        </div>
        <div class="badge" id="badge">未开始</div>
      </div>

      <button id="toggle">开始</button>
    </div>
  </div>

  <audio id="audio" playsinline webkit-playsinline preload="auto"></audio>

<script>
let lines = [];
let idx = 0;
let paused = false;
let playing = false;
let runId = 0;

const audio = document.getElementById("audio");
const elInput = document.getElementById("input");
const elGap = document.getElementById("gap");
const btn = document.getElementById("toggle");
const elBadge = document.getElementById("badge");

function setBadge(t){ elBadge.textContent = t; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function clean(text){ return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }

// 防连点
let lastClickAt = 0;
function clickGuard(){
  const now = Date.now();
  if (now - lastClickAt < 300) return false;
  lastClickAt = now;
  return true;
}

function stopAudio(){
  try{ audio.pause(); }catch(_){}
  try{ audio.currentTime = 0; }catch(_){}
}

async function waitUntilResumed(myRunId){
  while (paused && myRunId === runId){
    await sleep(120);
  }
}

// 暂停时不扣秒
async function waitGapSeconds(myRunId){
  let remaining = Number(elGap.value) * 1000;
  let last = performance.now();

  while (remaining > 0 && myRunId === runId){
    if (paused){
      last = performance.now();
      await sleep(120);
      continue;
    }
    await sleep(80);
    const now = performance.now();
    const delta = now - last;
    last = now;
    remaining -= delta;
  }
}

// 播放一次：先 fetch 拿到 blob（这样能看到后端真实错误）
async function playOnce(text, myRunId){
  if (myRunId !== runId) return;

  if (paused){
    await waitUntilResumed(myRunId);
    if (myRunId !== runId) return;
  }

  // ✅ 加随机参数，避开缓存/中间层复用
  const url = `/api/tts?text=${encodeURIComponent(text)}&_=${Date.now()}`;

  // 先请求，拿到真实 status
  const res = await fetch(url, { cache: "no-store" });

  if (!res.ok){
    // 尝试读一点文字出来（很多后端会返回错误信息）
    let msg = "";
    try{ msg = await res.text(); }catch(_){}
    msg = (msg || "").trim().slice(0, 80);
    throw new Error(`接口失败 ${res.status} ${msg}`);
  }

  const ct = (res.headers.get("content-type") || "").toLowerCase();
  if (!ct.includes("audio") && !ct.includes("mpeg") && !ct.includes("mp3")){
    let msg = "";
    try{ msg = await res.text(); }catch(_){}
    msg = (msg || "").trim().slice(0, 80);
    throw new Error(`不是音频 ${ct} ${msg}`);
  }

  const blob = await res.blob();
  const objUrl = URL.createObjectURL(blob);

  try{
    await new Promise((resolve, reject) => {
      if (myRunId !== runId) return resolve();
      audio.onended = resolve;
      audio.onerror = () => reject(new Error("音频播放失败"));
      audio.src = objUrl;
      audio.load();
      audio.play().catch(reject);
    });
  } finally {
    URL.revokeObjectURL(objUrl);
  }
}

function finish(){
  playing = false;
  paused = false;
  stopAudio();
  btn.textContent = "开始";
  elInput.disabled = false;
  elGap.disabled = false;
  setBadge("完成");
}

async function loop(myRunId){
  playing = true;

  while (myRunId === runId){
    if (paused){
      await waitUntilResumed(myRunId);
      if (myRunId !== runId) return;
    }

    if (idx >= lines.length){
      if (paused){
        setBadge("已暂停");
        await waitUntilResumed(myRunId);
        if (myRunId !== runId) return;
      }
      break;
    }

    try{
      setBadge("进行中");

      // 每条读 2 遍
      await playOnce(lines[idx], myRunId);
      if (myRunId !== runId) return;
      if (paused){ stopAudio(); continue; }

      await playOnce(lines[idx], myRunId);
      if (myRunId !== runId) return;
      if (paused){ stopAudio(); continue; }

    }catch(e){
      console.error(e);
      setBadge(("出错：" + (e.message || "未知错误")).slice(0, 28));
      playing = false;
      paused = false;
      stopAudio();
      btn.textContent = "开始";
      elInput.disabled = false;
      elGap.disabled = false;
      return;
    }

    await waitGapSeconds(myRunId);
    if (myRunId !== runId) return;

    if (paused){
      await waitUntilResumed(myRunId);
      if (myRunId !== runId) return;
    }

    idx++;
  }

  if (myRunId === runId){
    finish();
  }
}

btn.onclick = ()=>{
  if (!clickGuard()) return;

  if (!playing){
    lines = clean(elInput.value);
    if (!lines.length){
      setBadge("请先粘贴内容");
      return;
    }
    idx = 0;
    paused = false;

    runId++;
    const myRunId = runId;

    elInput.disabled = true;
    elGap.disabled = true;

    btn.textContent = "暂停";
    setBadge("进行中");
    loop(myRunId);
    return;
  }

  paused = !paused;
  if (paused){
    stopAudio();
    btn.textContent = "继续";
    setBadge("已暂停");
  }else{
    btn.textContent = "暂停";
    setBadge("进行中");
  }
};
</script>
</body>
</html>