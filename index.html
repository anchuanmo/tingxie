<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>听写助手</title>
  <style>
    body{font-family:system-ui; padding:16px;}
    textarea{width:100%; height:180px; font-size:16px;}
    button{font-size:22px; padding:16px 24px; margin-top:14px;}
    select{font-size:16px; padding:6px 8px;}
    .muted{color:#666; font-size:14px; margin-bottom:8px;}
    .status{margin-top:12px; font-size:16px;}
    .current{margin-top:6px; font-size:20px;}
  </style>
</head>
<body>

<h2>听写助手（微信打开）</h2>

<div class="muted">
  一行一条。每条自动读 <b>2 遍</b>，再停指定秒数。
</div>

<textarea id="input" placeholder="例如：
important
take a walk
聚精会神"></textarea>

<div style="margin-top:10px;">
  每条停
  <select id="gap">
    <option value="3" selected>3 秒</option>
    <option value="5">5 秒</option>
    <option value="8">8 秒</option>
    <option value="10">10 秒</option>
  </select>
</div>

<button id="toggle">开始</button>

<div class="status" id="status">未开始</div>
<div class="current" id="line"></div>

<audio id="audio" preload="auto"></audio>

<script>
let lines = [];
let idx = 0;
let paused = false;
let playing = false;

const elInput = document.getElementById("input");
const elGap = document.getElementById("gap");
const btn = document.getElementById("toggle");
const elStatus = document.getElementById("status");
const elLine = document.getElementById("line");
const audio = document.getElementById("audio");

function clean(text){
  return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function updateUI(){
  if (!lines.length || idx >= lines.length){
    elLine.textContent = "";
    return;
  }
  elStatus.textContent =
    `第 ${idx+1} / ${lines.length} 条` + (paused ? "（已暂停）" : "");
  elLine.textContent = lines[idx];
}

async function playOnce(text){
  const url = `/api/tts?text=${encodeURIComponent(text)}`;
  return new Promise((resolve,reject)=>{
    audio.src = url;
    audio.onended = resolve;
    audio.onerror = reject;
    audio.play().catch(reject);
  });
}

async function waitGap(){
  let remaining = Number(elGap.value) * 1000;
  while (remaining > 0){
    if (paused){
      await sleep(200);
      continue;
    }
    const step = Math.min(200, remaining);
    await sleep(step);
    remaining -= step;
  }
}

async function loop(){
  playing = true;

  while (true){
    // 如果全部完成，明确结束
    if (idx >= lines.length){
      break;
    }

    // 暂停时，彻底冻结
    while (paused){
      await sleep(200);
    }

    updateUI();

    try{
      // 第 1 遍
      await playOnce(lines[idx]);
      if (paused) continue;

      // 第 2 遍
      await playOnce(lines[idx]);
    }catch(e){
      elStatus.textContent = "播放失败";
      console.error(e);
      break;
    }

    // 停顿阶段（最后一条也必须完整等完）
    await waitGap();

    // 明确进入下一条
    idx++;
  }

  // 只有在 while 正常退出后，才允许结束
  playing = false;
  paused = false;
  btn.textContent = "开始";
  elInput.disabled = false;
  elStatus.textContent = "已结束 ✅";
}

btn.onclick = ()=>{
  // 开始
  if (!playing){
    lines = clean(elInput.value);
    if (!lines.length){
      elStatus.textContent = "请先粘贴内容";
      return;
    }
    idx = 0;
    paused = false;
    elInput.disabled = true;
    btn.textContent = "暂停";
    loop();
    return;
  }

  // 暂停 / 继续
  paused = !paused;
  if (paused){
    audio.pause();
    btn.textContent = "继续";
  }else{
    audio.play().catch(()=>{});
    btn.textContent = "暂停";
  }
  updateUI();
};
</script>

</body>
</html>